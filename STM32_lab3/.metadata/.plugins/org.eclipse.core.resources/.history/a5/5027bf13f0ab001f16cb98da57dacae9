/*
 * fsm_setting.c
 *
 *  Created on: Nov 11, 2024
 *      Author: NGUYEN GIAP
 */

#include "fsm_setting.h"
#include "global.h"
#include "traffic_light.h"
#include "main.h"

int tmp_redCount = 1;
int tmp_yellowCount = 1;
int tmp_greenCount = 1;

int ledBlinky = 1000; // 500ms

void fsm_setting(){
	switch(status){
	case NORMAL:
		clearAllLeds();

		if(isButtonPressed(0) == 1){
			status = SET_RED;
		}
		if(isButtonPressed(1)); //do nothing
//		if(isButtonPressed(2) == 1){
//			redCount = redCountInit;
//			yellowCount = yellowCountInit;
//			greenCount = greenCountInit;
//			changeCountToSecond();
//
//			status = INIT;
//		}
		break;
	case SET_RED:
		if(isTimerExpired(0) == 1){
			clearAllLeds();
			setTimer(0, 500);
			toggleRed1();
			toggleRed2();
		}

		if(isButtonPressed(0) == 1){
			status = SET_YELLOW;
		}
		if(isButtonPressed(1) == 1){
			tmp_redCount++;
			while (tmp_redCount < 1) tmp_redCount += 99;
			while (tmp_redCount > 99) tmp_redCount -= 99;
		}
//		if(isButtonPressed(2) == 1){
//			status = CHECK_VALID;
//		}

		break;
	case SET_YELLOW:
		if(isTimerExpired(0) == 1){
			clearAllLeds();
			setTimer(0, 500);
			toggleYellow1();
			toggleYellow2();
		}
		if(isButtonPressed(0) == 1){
			status = SET_GREEN;
		}
		if(isButtonPressed(1) == 1){
			tmp_yellowCount++;
			while (tmp_yellowCount < 1) tmp_yellowCount += 99;
			while (tmp_yellowCount > 99) tmp_yellowCount -= 99;
		}
//		if(isButtonPressed(2) == 1){
//			status = CHECK_VALID;
//		}
		break;
	case SET_GREEN:
		if(isTimerExpired(0) == 1){
			clearAllLeds();
			setTimer(0, 500);
			toggleGreen1();
			toggleGreen2();
		}
		if(isButtonPressed(0) == 1){
			status = NORMAL;
		}
		if(isButtonPressed(1) == 1){
			tmp_greenCount++;
			while (tmp_greenCount < 1) tmp_greenCount += 99;
			while (tmp_greenCount > 99) tmp_greenCount -= 99;
		}
//		if(isButtonPressed(2) == 1){
//			status = CHECK_VALID;
//		}
		break;
	case CHECK_VALID:
		if (tmp_redCount == tmp_yellowCount + tmp_greenCount){
			redCount = tmp_redCount;
			yellowCount = tmp_yellowCount;
			greenCount = tmp_greenCount;
			changeCountToSecond();
		}
		tmp_redCount = 1;
		tmp_yellowCount = 1;
		tmp_greenCount = 1;
		status = INIT;
		break;
	default:
		break;
	}
}
